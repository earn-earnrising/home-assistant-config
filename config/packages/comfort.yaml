homeassistant:
  customize:
    sensor.netatmo_exterior_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_exterior_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_exterior_min_temp:
      friendly_name: 'Mínima de hoy'
    sensor.netatmo_exterior_max_temp:
      friendly_name: 'Máxima de hoy'
    sensor.netatmo_exterior_battery:
      friendly_name: 'Netatmo exterior'
      device_class: 'battery'
    sensor.netatmo_exterior_radio:
      friendly_name: 'Señal exterior'
    sensor.netatmo_pluviometro_rain:
      friendly_name: 'Previsión lluvia'
    sensor.netatmo_pluviometro_sum_rain_1:
      friendly_name: 'Lluvia última hora'
    sensor.netatmo_pluviometro_sum_rain_24:
      friendly_name: 'Lluvia 24 horas'
    sensor.netatmo_pluviometro_battery:
      friendly_name: 'Netatmo pluviómetro'
      device_class: 'battery'
    sensor.netatmo_pluviometro_radio:
      friendly_name: 'Señal pluviómetro'
    sensor.netatmo_salon_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_salon_min_temp:
      friendly_name: 'Mínima de hoy'
    sensor.netatmo_salon_max_temp:
      friendly_name: 'Máxima de hoy'
    sensor.netatmo_salon_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_salon_noise:
      friendly_name: 'Nivel de ruido'
    sensor.netatmo_salon_pressure:
      friendly_name: 'Presión atmosférica'
    sensor.netatmo_salon_co2:
      friendly_name: 'Nivel CO2'
    sensor.netatmo_salon_wifi:
      friendly_name: 'Señal Wifi Netatmo'
    sensor.netatmo_anemometro_angle:
      friendly_name: 'Dirección viento'
    sensor.netatmo_anemometro_battery:
      friendly_name: 'Netatmo anemómetro'
      device_class: 'battery'
    sensor.netatmo_anemometro_gust_angle:
      friendly_name: 'Dirección rachas'
    sensor.netatmo_anemometro_gust_strength:
      friendly_name: 'Velocidad rachas'
    sensor.netatmo_anemometro_radio:
      friendly_name: 'Señal anemómetro'
    sensor.netatmo_anemometro_strength:
      friendly_name: 'Velocidad viento'
    sensor.netatmo_suite_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_suite_min_temp:
      friendly_name: 'Mínima de hoy'
    sensor.netatmo_suite_max_temp:
      friendly_name: 'Máxima de hoy'
    sensor.netatmo_suite_co2:
      friendly_name: 'Nivel CO2'
    sensor.netatmo_suite_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_suite_battery:
      friendly_name: 'Netatmo suite'
      device_class: 'battery'
    sensor.netatmo_suite_radio:
      friendly_name: 'Señal suite'
    sensor.netatmo_habitacion_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_habitacion_min_temp:
      friendly_name: 'Mínima de hoy'
    sensor.netatmo_habitacion_max_temp:
      friendly_name: 'Máxima de hoy'
    sensor.netatmo_habitacion_co2:
      friendly_name: 'Nivel CO2'
    sensor.netatmo_habitacion_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_habitacion_battery:
      friendly_name: 'Netatmo hab. niños'
      device_class: 'battery'
    sensor.netatmo_habitacion_radio:
      friendly_name: 'Señal hab.niños'
    sensor.ground_floor_temperature:
      friendly_name: 'Temp media planta baja'
      icon: 'mdi:thermometer'
      unit_of_measurement: '°C'
    sensor.first_floor_temperature:
      friendly_name: 'Temp media 1ª planta'
      icon: 'mdi:thermometer'
      unit_of_measurement: '°C'
    switch.termostato:
      friendly_name: 'Calefacción'
      icon: mdi:radiator
    switch.termostato_modo_ausente:
      friendly_name: 'Modo ausente'
      icon: mdi:home-outline
    sensor.season:
      friendly_name: 'Estación'
    sensor.home_temperature_mean:
      friendly_name: 'Temp. media 24h'
      icon: 'mdi:thermometer'
      unit_of_measurement: '°C'
    sensor.home_temperature:
      friendly_name: 'Temp. media'
    sensor.recibidor_termometro_temperatura:
      friendly_name: 'Temperatura'
      unit_of_measurement: '°C'

recorder:
  exclude:
    entities:
      - sensor.season

      - sensor.pws_weather
      - sensor.pws_weather_1d_metric
      - sensor.pws_alerts
      - sensor.recibidor_termometro_temperatura
      - sensor.exterior_termometro_temperatura
      - sensor.exterior_termometro_humedad
      - sensor.exterior_termometro_max_temp
      - sensor.exterior_termometro_min_temp
      - sensor.netatmo_exterior_radio
      - sensor.netatmo_exterior_battery

      - sensor.salon_termometro_co2
      - sensor.salon_termometro_temperatura
      - sensor.salon_termometro_humedad
      - sensor.salon_termometro_max_temp
      - sensor.salon_termometro_min_temp
      - sensor.salon_termometro_ruido
      - sensor.salon_termometro_presion

      - sensor.suite_termometro_co2
      - sensor.suite_termometro_temperatura
      - sensor.suite_termometro_humedad
      - sensor.suite_termometro_max_temp
      - sensor.suite_termometro_min_temp
      - sensor.netatmo_suite_radio
      - sensor.netatmo_suite_battery

      - sensor.habitacion_termometro_co2
      - sensor.habitacion_termometro_temperatura
      - sensor.habitacion_termometro_humedad
      - sensor.habitacion_termometro_max_temp
      - sensor.habitacion_termometro_min_temp
      - sensor.netatmo_habitacion_radio
      - sensor.netatmo_habitacion_battery

      - sensor.exterior_pluviometro_lluvia
      - sensor.exterior_pluviometro_lluvia_1
      - sensor.exterior_pluviometro_lluvia_24
      - sensor.netatmo_pluviometro_radio
      - sensor.netatmo_pluviometro_battery

      - sensor.exterior_anemometro_velocidad_viento
      - sensor.netatmo_anemometro_gust_angle
      - sensor.netatmo_anemometro_angle
      - sensor.netatmo_anemometro_radio
      - sensor.netatmo_anemometro_battery

      - binary_sensor.netatmo_exterior_temperature_down
      - binary_sensor.netatmo_exterior_temperature_up
      - sensor.netatmo_exterior_temperature_trend

      - binary_sensor.netatmo_salon_temperature_down
      - binary_sensor.netatmo_salon_temperature_up
      - sensor.netatmo_salon_temperature_trend

      - binary_sensor.office_sensor_temperature_down
      - binary_sensor.office_sensor_temperature_up
      - sensor.office_sensor_temperature_trend

      - binary_sensor.entrance_hall_termostato_temperature_down
      - binary_sensor.entrance_hall_termostato_temperature_up
      - sensor.entrance_hall_termostato_temperature_trend

      - binary_sensor.netatmo_suite_temperature_down
      - binary_sensor.netatmo_suite_temperature_up
      - sensor.netatmo_suite_temperature_trend

      - binary_sensor.netatmo_habitacion_temperature_down
      - binary_sensor.netatmo_habitacion_temperature_up
      - sensor.netatmo_habitacion_temperature_trend

      - binary_sensor.first_floor_temperature_up
      - binary_sensor.first_floor_temperature_down
      - sensor.first_floor_temperature_trend

      - binary_sensor.netatmo_salon_co2_down
      - binary_sensor.netatmo_salon_co2_up
      - sensor.netatmo_salon_co2_trend
      
      - binary_sensor.netatmo_suite_co2_down
      - binary_sensor.netatmo_suite_co2_up
      - sensor.netatmo_suite_co2_trend

      - binary_sensor.netatmo_habitacion_co2_down
      - binary_sensor.netatmo_habitacion_co2_up
      - sensor.netatmo_habitacion_co2_trend

      - binary_sensor.ground_floor_temperature_up
      - binary_sensor.ground_floor_temperature_down
      - sensor.ground_floor_temperature_trend

group:
  Temperatura:
    entities:
      - sensor.netatmo_exterior_temperature
      - sensor.netatmo_exterior_min_temp
      - sensor.netatmo_exterior_max_temp
      - history_graph.temperatura_exterior
      - sensor.netatmo_exterior_humidity
      - sensor.netatmo_exterior_temperature_trend
      - sensor.netatmo_exterior_radio
  
  Meteorología:
    entities:
      - sensor.pws_weather_1d_metric
      - sensor.sunrise
      - sensor.sunset
      - sensor.season
  
  Lluvia:
    entities:
      - sensor.netatmo_pluviometro_rain
      - sensor.netatmo_pluviometro_sum_rain_1
      - sensor.netatmo_pluviometro_sum_rain_24
      - sensor.netatmo_pluviometro_radio
  
  Viento:
    entities:
      - sensor.netatmo_anemometro_strength
      - sensor.netatmo_anemometro_angle
      - sensor.netatmo_anemometro_gust_strength
      - sensor.netatmo_anemometro_gust_angle
      - sensor.netatmo_anemometro_radio

  Calefacción:
    entities:
      - switch.termostato
      - switch.termostato_modo_ausente
      - climate.termostato
  
  Confort:
    entities:
      - input_boolean.auto_comfort
      - sensor.ground_floor_temperature
      - sensor.ground_floor_temperature_trend
      - sensor.first_floor_temperature
      - sensor.first_floor_temperature_trend
      - sensor.home_temperature_mean
      - history_graph.temperatura_media_casa
      - group.unidad_familiar
      - switch.termostato
      - switch.termostato_modo_ausente
      - climate.termostato

history_graph:
  temperature_outside:
    name: Temperatura exterior
    entities:
      - sensor.netatmo_exterior_temperature
    hours_to_show: 24
    refresh: 60

  home_temperature:
    name: Temperatura media casa
    entities:
      - sensor.home_temperature
    hours_to_show: 336
    refresh: 600

binary_sensor:
  - platform: template
    sensors:
      comfort_state:
        device_class: heat
        friendly_name: 'Auto confort sensor'
        value_template: "{{ states('sensor.first_floor_temperature')|float < states.climate.termostato.attributes.temperature|float and is_state('group.unidad_familiar', 'home') and is_state('switch.termostato', 'on') and is_state('switch.termostato_modo_ausente','off') and is_state_attr('climate.termostato', 'operation_mode', 'idle') and is_state('binary_sensor.first_floor_temperature_down','on') }}"
  # Trend sensors
  - platform: trend
    sensors:
      netatmo_exterior_temperature_down:
        entity_id: sensor.netatmo_exterior_temperature
        invert: true
      netatmo_exterior_temperature_up:
        entity_id: sensor.netatmo_exterior_temperature
  
      netatmo_salon_temperature_down:
        entity_id: sensor.netatmo_salon_temperature
        invert: true
      netatmo_salon_temperature_up:
        entity_id: sensor.netatmo_salon_temperature
  
      office_sensor_temperature_down:
        entity_id: sensor.despacho_termometro_temperatura
        invert: true
      office_sensor_temperature_up:
        entity_id: sensor.despacho_termometro_temperatura
  
      entrance_hall_termostato_temperature_down:
        entity_id: sensor.recibidor_termometro_temperatura
        invert: true
      entrance_hall_termostato_temperature_up:
        entity_id: sensor.recibidor_termometro_temperatura
        
      netatmo_suite_temperature_down:
        entity_id: sensor.suite_termometro_temperatura
        invert: true
      netatmo_suite_temperature_up:
        entity_id: sensor.suite_termometro_temperatura
  
      netatmo_habitacion_temperature_down:
        entity_id: sensor.habitacion_termometro_temperatura
        invert: true
      netatmo_habitacion_temperature_up:
        entity_id: sensor.habitacion_termometro_temperatura
  
      netatmo_salon_co2_down:
        entity_id: sensor.salon_termometro_co2
        invert: true
      netatmo_salon_co2_up:
        entity_id: sensor.salon_termometro_co2
  
      netatmo_suite_co2_down:
        entity_id: sensor.suite_termometro_co2
        invert: true
      netatmo_suite_co2_up:
        entity_id: sensor.suite_termometro_co2
  
      netatmo_habitacion_co2_down:
        entity_id: sensor.habitacion_termometro_co2
        invert: true
      netatmo_habitacion_co2_up:
        entity_id: sensor.habitacion_termometro_co2
  
      ground_floor_temperature_down:
        entity_id: sensor.ground_floor_temperature
        invert: true
        max_samples: 5
      ground_floor_temperature_up:
        entity_id: sensor.ground_floor_temperature
        max_samples: 5
  
      first_floor_temperature_down:
        entity_id: sensor.first_floor_temperature
        invert: true
        max_samples: 5
      first_floor_temperature_up:
        entity_id: sensor.first_floor_temperature
        max_samples: 5

sensor:
  - platform: netatmo
    modules:
      Salón:
        - temperature
        - min_temp
        - max_temp
        - humidity
        - noise
        - pressure
        - co2
        - wifi_status
      Suite:
        - temperature
        - min_temp
        - max_temp
        - humidity
        - co2
        - battery_vp
        - rf_status
      Habitación:
        - temperature
        - min_temp
        - max_temp
        - humidity
        - co2
        - battery_vp
        - rf_status
      Exterior:
        - temperature
        - min_temp
        - max_temp
        - humidity
        - battery_vp
        - rf_status
      Pluviómetro:
        - rain
        - sum_rain_1
        - sum_rain_24
        - battery_vp
        - rf_status
      Anemómetro:
        - windangle
        - windstrength
        - gustangle
        - guststrength
        - battery_vp
        - rf_status

  # Sensor to define the season of the year
  - platform: season
  
  # Sensor to get sunset and sunrise hours with a custom format.
  - platform: template
    sensors:
      sunrise:
        friendly_name: 'Amanecer'
        value_template: '{{ as_timestamp(states.sun.sun.attributes.next_rising)|timestamp_custom("%H:%M:%S") }}'
      sunset:
        friendly_name: 'Puesta de sol'
        value_template: '{{ as_timestamp(states.sun.sun.attributes.next_setting)|timestamp_custom("%H:%M:%S") }}'

  - platform: wunderground
    api_key: !secret weather_underground_api_key
    lang: SP
    monitored_conditions:
      - alerts
      - weather
      - weather_1d_metric
  
  # Comfort sensors
  - platform: min_max
    name: ground_floor_temperature
    type: mean
    round_digits: 1
    entity_ids:
      - sensor.recibidor_termometro_temperatura
      - sensor.netatmo_salon_temperature
      - sensor.despacho_sensor_movimiento_temperature
      - sensor.porche_sensor_puerta_temperature
  
  - platform: min_max
    name: first_floor_temperature
    type: mean
    round_digits: 1
    entity_ids:
      - sensor.netatmo_suite_temperature
      - sensor.netatmo_habitacion_temperature

  - platform: min_max
    name: home_temperature
    type: mean
    round_digits: 1
    entity_ids:
      - sensor.netatmo_suite_temperature
      - sensor.netatmo_habitacion_temperature
      - sensor.netatmo_salon_temperature
      - sensor.recibidor_termometro_temperatura
      - sensor.despacho_sensor_movimiento_temperature
      - sensor.porche_sensor_puerta_temperature

  - platform: statistics
    name: home_temperature
    entity_id: sensor.home_temperature
    sampling_size: 1440
    max_age:
      hours: 24

  - platform: template
    sensors:
      ground_floor_temperature_trend:
        friendly_name: 'Tend temp planta baja'
        value_template: >-
          {%- if is_state("binary_sensor.ground_floor_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.ground_floor_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.ground_floor_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.ground_floor_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      first_floor_temperature_trend:
        friendly_name: 'Tend temp 1ª planta'
        value_template: >-
          {%- if is_state("binary_sensor.first_floor_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.first_floor_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.first_floor_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.first_floor_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_exterior_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_exterior_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_exterior_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_exterior_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_exterior_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      office_sensor_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.office_sensor_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.office_sensor_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.office_sensor_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.office_sensor_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_salon_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_salon_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_salon_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_salon_co2_trend:
        friendly_name: 'Tendencia co2'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_co2_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_salon_co2_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_co2_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_salon_co2_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      entrance_hall_termostato_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.entrance_hall_termostato_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.entrance_hall_termostato_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.entrance_hall_termostato_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.entrance_hall_termostato_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_suite_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_suite_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_suite_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_suite_co2_trend:
        friendly_name: 'Tendencia CO2'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_co2_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_suite_co2_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_co2_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_suite_co2_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_habitacion_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_habitacion_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_habitacion_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_habitacion_co2_trend:
        friendly_name: 'Tendencia CO2'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_co2_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_habitacion_co2_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_co2_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_habitacion_co2_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}

switch:
  - platform: mqtt
    name: 'termostato'
    state_topic: 'home/heating/status'
    command_topic: 'home/heating/status'
    payload_on: 'ON'
    payload_off: 'OFF'
    optimistic: false
    qos: 0
    retain: true
  
  - platform: template
    switches:
      termostato_modo_ausente:
        value_template: >-
          {%- if states("climate.termostato") != "unknown" -%}
            {{ states.climate.termostato.attributes.away_mode }}
          {%- else -%}
            off
          {%- endif %}
        turn_on:
          service: climate.set_away_mode
          entity_id: climate.termostato
          data:
            away_mode: true
        turn_off:
          service: climate.set_away_mode
          entity_id: climate.termostato
          data:
            away_mode: false

input_boolean:
  auto_comfort:
    name: Auto confort
    icon: 'mdi:radiator'

automation:
  #############################################################
  # Heating automations
  #############################################################
  
  # When the switch.termostato changes to on
  - alias: 'Heating on'
    trigger:
      platform: state
      entity_id: switch.termostato
      to: 'on'
    action:
      # Turn on thermostat
      - service: script.turn_on
        entity_id: script.climate_power_on
  
  # When the switch.termostato changes to off
  - alias: 'Heating off'
    trigger:
      platform: state
      entity_id: switch.termostato
      to: 'off'
    action:
      # Turn off thermostat
      - service: script.turn_on
        entity_id: script.climate_power_off

    # Automatic Heating on when home mean temperature for last 24 hours is below 18.5 degrees
  - alias: 'Automatic heating on'
    trigger:
      platform: numeric_state
      entity_id: sensor.home_temperature_mean
      below: 18.5
    condition:
      condition: state
      entity_id: 'switch.termostato'
      state: 'off'
    action:
      - service: switch.turn_on
        entity_id: switch.termostato
      - service: logbook.log
        data:
          name: 'Calefacción'
          message: 'encendida por baja temperatura'
          entity_id: climate.termostato
          domain: climate
      - service: telegram_bot.send_message
        data_template:
          message: 'Como ya empieza a hacer fresquito, he encendido la calefaccción. Convendría hacer un purgado de los radiadores.'
          target: 
            - !secret hokusphone_telegram_chat_id
            - !secret geniphone_telegram_chat_id
          disable_notification: false
          inline_keyboard:
                 - 'Apaga la calefacción:/switch.turn_off#switch.termostato'

    # Automatic Heating off when home mean temperature for last 24 hours is above 22 degrees
  - alias: 'Automatic heating off'
    trigger:
      platform: numeric_state
      entity_id: sensor.home_temperature_mean
      above: 22
    condition:
      condition: state
      entity_id: 'switch.termostato'
      state: 'on'
    action:
      - service: switch.turn_off
        entity_id: switch.termostato
      - service: logbook.log
        data:
          name: 'Calefacción'
          message: 'apagada por alta temperatura'
          entity_id: climate.termostato
          domain: climate
      - service: telegram_bot.send_message
        data_template:
          message: 'Empieza el calor!!!! He apagado la calefaccción.'
          target: 
            - !secret hokusphone_telegram_chat_id
            - !secret geniphone_telegram_chat_id
          disable_notification: false
          inline_keyboard:
                 - 'Enciende la calefacción:/switch.turn_on#switch.termostato'

    # Turn on auto comfort mode
  - alias: 'Auto comfort on'
    trigger:
      platform: state
      entity_id: input_boolean.auto_comfort
      to: 'on'
    action:
      - service: script.turn_on
        entity_id: script.comfort_mode_on

    # Turn off auto comfort mode
  - alias: 'Auto comfort off'
    trigger:
      platform: state
      entity_id: input_boolean.auto_comfort
      to: 'off'
    action:
      - service: script.turn_off
        entity_id: script.comfort_mode_off


  # When average temp on ground floor or first floor is under target climate temperature
  # If:
  #  - There is someone at home
  #  - Heating is connected
  #  - Heating is idle
  #  - Temperature trend in ground floor or first floor is going down
  #  - After 16:00
  # Then turn on auto comfort
  - alias: 'Heating comfort'
    trigger:
      platform: state
      entity_id: binary_sensor.comfort_state
      to: 'on'
    condition:
      - condition: time
        after: '16:00'
    action:
      - service: telegram_bot.send_message
        data_template:
          message: > 
            Calefacción encendida para mejorar el confort
            
            Temperatura objetivo: {{ states.climate.termostato.attributes.temperature }}
            
            Temperatura media planta baja: {{states.sensor.ground_floor_temperature.state}}
            
            Temperatura media primera planta: {{states.sensor.first_floor_temperature.state}}
            
            Ocupación: {{states.group.unidad_familiar.state}}
            
            Estado calefacción: {{states.switch.termostato.state}}
            
            Modo ausente: {{states.switch.termostato_modo_ausente.state}}
            
            Estado termostato: {{states.climate.termostato.attributes.operation_mode}}
            
            Tendencia temperatura planta baja: {{states.sensor.ground_floor_temperature_trend.state}}
            
            Tendencia temperatura primera planta: {{states.sensor.first_floor_temperature_trend.state}}

          inline_keyboard: 
            - 'Desconectar:/homeassistant.turn_off#input_boolean.auto_comfort'

      - service: homeassistant.turn_on
        data:
          entity_id: input_boolean.auto_comfort

script:
  # Power off climate
  climate_power_off:
    alias: 'Power off thermostat'
    sequence:
      - service: climate.set_temperature
        entity_id: climate.termostato
        data:
          temperature: 11.5
      - service: home_assistant.update_entity
        entity_id: climate.termostato

  # Power off climate
  climate_power_on:
    alias: 'Power on thermostat'
    sequence:
      - service: climate.set_away_mode
        entity_id: climate.termostato
        data:
          away_mode: false
      - service: home_assistant.update_entity
        entity_id: climate.termostato

  # Comfort mode on
  comfort_mode_on:
    alias: 'Turn on comfort mode'
    sequence:
      # Set temperature to 23 degrees
      - service: climate.set_temperature
        data_template:
          entity_id: climate.termostato
          temperature: 23
      # Update entity
      - service: home_assistant.update_entity
        entity_id: climate.termostato
      - delay:
           minutes: 90
      # Turn off auto comfort (after 90 minutes)
      - service: homeassistant.turn_off
        data:
          entity_id: input_boolean.auto_comfort

  # Comfort mode off
  comfort_mode_off:
    alias: 'Turn off comfort mode'
    sequence:
      # Turn on thermostat away mode 
      - service: climate.set_away_mode
        entity_id: climate.termostato
        data:
          away_mode: true
      - delay:
          seconds: 5
     # Turn off thermostat away mode 
      - service: climate.set_away_mode
        entity_id: climate.termostato
        data:
          away_mode: false
      # Update entity
      - service: home_assistant.update_entity
        entity_id: climate.termostato

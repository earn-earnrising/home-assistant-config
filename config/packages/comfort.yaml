homeassistant:
  customize:
    climate.netatmo_general:
      friendly_name: 'Calefacción'
    sensor.netatmo_exterior_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_exterior_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_exterior_min_temp:
      friendly_name: 'Mínima de hoy'
      icon: 'mdi:thermometer-minus'
    sensor.netatmo_exterior_max_temp:
      friendly_name: 'Máxima de hoy'
      icon: 'mdi:thermometer-plus'
    sensor.netatmo_exterior_battery:
      friendly_name: 'Netatmo exterior'
      device_class: 'battery'
    sensor.netatmo_exterior_radio:
      friendly_name: 'Señal exterior'
    sensor.netatmo_pluviometro_rain:
      friendly_name: 'Previsión lluvia'
    sensor.netatmo_pluviometro_sum_rain_1:
      friendly_name: 'Lluvia última hora'
    sensor.netatmo_pluviometro_sum_rain_24:
      friendly_name: 'Lluvia 24 horas'
    sensor.netatmo_pluviometro_battery:
      friendly_name: 'Netatmo pluviómetro'
      device_class: 'battery'
    sensor.netatmo_pluviometro_radio:
      friendly_name: 'Señal pluviómetro'
    sensor.netatmo_salon_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_salon_min_temp:
      friendly_name: 'Mínima de hoy'
      icon: 'mdi:thermometer-minus'
    sensor.netatmo_salon_max_temp:
      friendly_name: 'Máxima de hoy'
      icon: 'mdi:thermometer-plus'
    sensor.netatmo_salon_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_salon_noise:
      friendly_name: 'Nivel de ruido'
    sensor.netatmo_salon_pressure:
      friendly_name: 'Presión atmosférica'
    sensor.netatmo_salon_co2:
      friendly_name: 'Nivel CO2'
    sensor.netatmo_salon_wifi:
      friendly_name: 'Señal Wifi Netatmo'
    sensor.netatmo_anemometro_angle:
      friendly_name: 'Dirección viento'
    sensor.netatmo_anemometro_battery:
      friendly_name: 'Netatmo anemómetro'
      device_class: 'battery'
    sensor.netatmo_anemometro_gust_angle:
      friendly_name: 'Dirección rachas'
    sensor.netatmo_anemometro_gust_strength:
      friendly_name: 'Velocidad rachas'
    sensor.netatmo_anemometro_radio:
      friendly_name: 'Señal anemómetro'
    sensor.netatmo_anemometro_strength:
      friendly_name: 'Velocidad viento'
    sensor.netatmo_suite_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_suite_min_temp:
      friendly_name: 'Mínima de hoy'
      icon: 'mdi:thermometer-minus'
    sensor.netatmo_suite_max_temp:
      friendly_name: 'Máxima de hoy'
      icon: 'mdi:thermometer-plus'
    sensor.netatmo_suite_co2:
      friendly_name: 'Nivel CO2'
    sensor.netatmo_suite_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_suite_battery:
      friendly_name: 'Netatmo suite'
      device_class: 'battery'
    sensor.netatmo_suite_radio:
      friendly_name: 'Señal suite'
    sensor.netatmo_habitacion_temperature:
      friendly_name: 'Temperatura'
    sensor.netatmo_habitacion_min_temp:
      friendly_name: 'Mínima de hoy'
      icon: 'mdi:thermometer-minus'
    sensor.netatmo_habitacion_max_temp:
      friendly_name: 'Máxima de hoy'
      icon: 'mdi:thermometer-plus'
    sensor.netatmo_habitacion_co2:
      friendly_name: 'Nivel CO2'
    sensor.netatmo_habitacion_humidity:
      friendly_name: 'Humedad'
    sensor.netatmo_habitacion_battery:
      friendly_name: 'Netatmo hab. niños'
      device_class: 'battery'
    sensor.netatmo_habitacion_radio:
      friendly_name: 'Señal hab.niños'
    sensor.ground_floor_temperature:
      friendly_name: 'Temp media planta baja'
      icon: 'mdi:thermometer'
      unit_of_measurement: '°C'
    sensor.first_floor_temperature:
      friendly_name: 'Temp media 1ª planta'
      icon: 'mdi:thermometer'
      unit_of_measurement: '°C'
    switch.thermostat_away_mode:
      friendly_name: 'Modo ausente'
      icon: mdi:home-outline
    sensor.season:
      friendly_name: 'Estación'
    sensor.home_temperature_mean:
      friendly_name: 'Temp. media 24h'
      icon: 'mdi:thermometer'
      unit_of_measurement: '°C'
    sensor.home_temperature:
      friendly_name: 'Temp. media'
    sensor.entrance_hall_thermostat_temperature:
      friendly_name: 'Temperatura'
      unit_of_measurement: '°C'
    sensor.dark_sky_summary_0d:
      friendly_name: 'Previsión'
    binary_sensor.summer_time:
      friendly_name: 'Horario de verano'

recorder:
  include:
    entities:
      - input_boolean.home_comfort_mode
      - sensor.netatmo_exterior_temperature
      - sensor.netatmo_exterior_humidity
      - sensor.netatmo_pluviometro_rain
      - sensor.netatmo_anemometro_strength
      - sensor.netatmo_salon_temperature
      - sensor.netatmo_salon_humidity
      - sensor.netatmo_salon_noise
      - sensor.netatmo_salon_pressure
      - sensor.netatmo_salon_co2
      - sensor.home_temperature
      - sensor.ground_floor_temperature
      - sensor.first_floor_temperature
      - sensor.netatmo_suite_temperature
      - sensor.netatmo_suite_co2
      - sensor.netatmo_suite_humidity
      - sensor.netatmo_habitacion_temperature
      - sensor.netatmo_habitacion_co2
      - sensor.netatmo_habitacion_humidity
      - sensor.entrance_hall_thermostat_temperature
      - sensor.despacho_sensor_movimiento_luminance
      - sensor.despacho_sensor_movimiento_temperature
      - sensor.entrance_hall_thermostat_target_temperature
      - sensor.porche_sensor_puerta_temperature

logbook:
  exclude:
    entities:
      - sensor.netatmo_exterior_temperature
      - sensor.netatmo_exterior_humidity
      - sensor.netatmo_pluviometro_rain
      - sensor.netatmo_anemometro_strength
      - sensor.netatmo_salon_temperature
      - sensor.netatmo_salon_humidity
      - sensor.netatmo_salon_noise
      - sensor.netatmo_salon_pressure
      - sensor.netatmo_salon_co2
      - sensor.home_temperature
      - sensor.ground_floor_temperature
      - sensor.first_floor_temperature
      - sensor.netatmo_suite_temperature
      - sensor.netatmo_suite_co2
      - sensor.netatmo_suite_humidity
      - sensor.netatmo_habitacion_temperature
      - sensor.netatmo_habitacion_co2
      - sensor.netatmo_habitacion_humidity
      - sensor.entrance_hall_thermostat_temperature
      - sensor.despacho_sensor_movimiento_luminance
      - sensor.despacho_sensor_movimiento_temperature
      - sensor.porche_sensor_puerta_temperature

history_graph:
  outside_temperature:
    name: Temperatura exterior
    entities:
      - sensor.netatmo_exterior_temperature
    hours_to_show: 24
    refresh: 60

  home_temperature:
    name: Temperatura media casa
    entities:
      - sensor.home_temperature
    hours_to_show: 336
    refresh: 600

binary_sensor:
  - platform: template
    sensors:
      # comfort_state is active when:
      # Average in first floor temperature is lower than climate target temperature
      # And there is someone at home
      # And heating is on
      # And heating away mode is off
      # And heating is idle
      # And first floor temperature trend is going down
      home_comfort_state:
        entity_id: sensor.first_floor_temperature, climate.netatmo_general, group.unidad_familiar, switch.thermostat_away_mode, binary_sensor.first_floor_temperature_down
        value_template: >- 
          {{ states('sensor.first_floor_temperature')|float < states.sensor.entrance_hall_thermostat_target_temperature|float
             and is_state('group.unidad_familiar', 'home')
             and not is_state('climate.netatmo_general', 'off')
             and is_state('switch.thermostat_away_mode','off')
             and is_state_attr('climate.netatmo_general', 'hvac_action', 'off')
             and is_state('binary_sensor.first_floor_temperature_down','on')
          }}
      summer_time:
        entity_id: sensor.date_time
        device_class: light
        value_template: '{{ as_timestamp(strptime(states.sensor.date_time.state, "%Y-%m-%d, %H:%M"))|timestamp_custom("%Z") == "CEST"}}'

  # Trend sensors
  - platform: trend
    sensors:
      netatmo_exterior_temperature_down:
        entity_id: sensor.netatmo_exterior_temperature
        invert: true
      netatmo_exterior_temperature_up:
        entity_id: sensor.netatmo_exterior_temperature
  
      netatmo_salon_temperature_down:
        entity_id: sensor.netatmo_salon_temperature
        invert: true
      netatmo_salon_temperature_up:
        entity_id: sensor.netatmo_salon_temperature
  
      office_sensor_temperature_down:
        entity_id: sensor.despacho_termometro_temperatura
        invert: true
      office_sensor_temperature_up:
        entity_id: sensor.despacho_termometro_temperatura
  
      entrance_hall_thermostat_temperature_down:
        entity_id: sensor.entrance_hall_thermostat_temperature
        invert: true
      entrance_hall_thermostat_temperature_up:
        entity_id: sensor.entrance_hall_thermostat_temperature
        
      netatmo_suite_temperature_down:
        entity_id: sensor.suite_termometro_temperatura
        invert: true
      netatmo_suite_temperature_up:
        entity_id: sensor.suite_termometro_temperatura
  
      netatmo_habitacion_temperature_down:
        entity_id: sensor.habitacion_termometro_temperatura
        invert: true
      netatmo_habitacion_temperature_up:
        entity_id: sensor.habitacion_termometro_temperatura
  
      netatmo_salon_co2_down:
        entity_id: sensor.salon_termometro_co2
        invert: true
      netatmo_salon_co2_up:
        entity_id: sensor.salon_termometro_co2
  
      netatmo_suite_co2_down:
        entity_id: sensor.suite_termometro_co2
        invert: true
      netatmo_suite_co2_up:
        entity_id: sensor.suite_termometro_co2
  
      netatmo_habitacion_co2_down:
        entity_id: sensor.habitacion_termometro_co2
        invert: true
      netatmo_habitacion_co2_up:
        entity_id: sensor.habitacion_termometro_co2
  
      ground_floor_temperature_down:
        entity_id: sensor.ground_floor_temperature
        invert: true
        max_samples: 5
      ground_floor_temperature_up:
        entity_id: sensor.ground_floor_temperature
        max_samples: 5
  
      first_floor_temperature_down:
        entity_id: sensor.first_floor_temperature
        invert: true
        max_samples: 5
      first_floor_temperature_up:
        entity_id: sensor.first_floor_temperature
        max_samples: 5

sensor:
#  - platform: netatmo
#    modules:
#      Salón:
#        - temperature
#        - min_temp
#        - max_temp
#        - humidity
#        - noise
#        - pressure
#        - co2
#        - wifi_status
#      Suite:
#        - temperature
#        - min_temp
#        - max_temp
#        - humidity
#        - co2
#        - battery_vp
#        - rf_status
#      Habitación:
#        - temperature
#        - min_temp
#        - max_temp
#        - humidity
#        - co2
#        - battery_vp
#        - rf_status
#      Exterior:
#        - temperature
#        - min_temp
#        - max_temp
#        - humidity
#        - battery_vp
#        - rf_status
#      Pluviómetro:
#        - rain
#        - sum_rain_1
#        - sum_rain_24
#        - battery_vp
#        - rf_status
#      Anemómetro:
#        - windangle
#        - windstrength
#        - gustangle
#        - guststrength
#        - battery_vp
#        - rf_status

  # Sensor to define the season of the year
  - platform: season
  
  # Sensor to get sunset and sunrise hours with a custom format.
  - platform: template
    sensors:
      sunrise:
        friendly_name: 'Amanecer'
        value_template: '{{ as_timestamp(states.sun.sun.attributes.next_rising)|timestamp_custom("%H:%M:%S") }}'
      sunset:
        friendly_name: 'Puesta de sol'
        value_template: '{{ as_timestamp(states.sun.sun.attributes.next_setting)|timestamp_custom("%H:%M:%S") }}'

  - platform: darksky
    api_key: !secret dark_sky_api_key
    forecast:
      - 0
    language: 'es'
    latitude: !secret ha_latitude
    longitude: !secret ha_longitude
    units: 'ca'
    monitored_conditions:
      - summary
      - icon
    scan_interval:
      hours: 1

  # Comfort sensors
  - platform: min_max
    name: ground_floor_temperature
    type: mean
    round_digits: 1
    entity_ids:
      - sensor.entrance_hall_thermostat_temperature
      - sensor.netatmo_salon_temperature
      - sensor.despacho_sensor_movimiento_temperature
      - sensor.porche_sensor_puerta_temperature
  
  - platform: min_max
    name: first_floor_temperature
    type: mean
    round_digits: 1
    entity_ids:
      - sensor.netatmo_suite_temperature
      - sensor.netatmo_habitacion_temperature

  - platform: min_max
    name: home_temperature
    type: mean
    round_digits: 1
    entity_ids:
      - sensor.netatmo_suite_temperature
      - sensor.netatmo_habitacion_temperature
      - sensor.netatmo_salon_temperature
      - sensor.entrance_hall_thermostat_temperature
      - sensor.despacho_sensor_movimiento_temperature
      - sensor.porche_sensor_puerta_temperature

  - platform: statistics
    name: home_temperature
    entity_id: sensor.home_temperature
    sampling_size: 1440
    max_age:
      hours: 24

  - platform: template
    sensors:
      entrance_hall_thermostat_target_temperature:
        entity_id: climate.netatmo_general
        value_template: "{{state_attr('climate.netatmo_general', 'temperature')}}"

      entrance_hall_thermostat_temperature:
        entity_id: climate.netatmo_general
        value_template: "{{state_attr('climate.netatmo_general', 'current_temperature')}}"

      ground_floor_temperature_trend:
        friendly_name: 'Tend temp planta baja'
        value_template: >-
          {%- if is_state("binary_sensor.ground_floor_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.ground_floor_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.ground_floor_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.ground_floor_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      first_floor_temperature_trend:
        friendly_name: 'Tend temp 1ª planta'
        value_template: >-
          {%- if is_state("binary_sensor.first_floor_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.first_floor_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.first_floor_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.first_floor_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_exterior_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_exterior_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_exterior_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_exterior_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_exterior_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      office_sensor_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.office_sensor_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.office_sensor_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.office_sensor_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.office_sensor_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_salon_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_salon_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_salon_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_salon_co2_trend:
        friendly_name: 'Tendencia co2'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_co2_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_salon_co2_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_salon_co2_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_salon_co2_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      entrance_hall_thermostat_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.entrance_hall_thermostat_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.entrance_hall_thermostat_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.entrance_hall_thermostat_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.entrance_hall_thermostat_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_suite_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_suite_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_suite_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_suite_co2_trend:
        friendly_name: 'Tendencia CO2'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_co2_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_suite_co2_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_suite_co2_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_suite_co2_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_habitacion_temperature_trend:
        friendly_name: 'Tendencia temp'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_temperature_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_habitacion_temperature_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_temperature_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_habitacion_temperature_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}
  
      netatmo_habitacion_co2_trend:
        friendly_name: 'Tendencia CO2'
        value_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_co2_down", "on") -%}
          En descenso
          {%- elif is_state("binary_sensor.netatmo_habitacion_co2_up", "on") -%}
          En aumento
          {%- else -%}
          Sin cambio
          {%- endif %}
        icon_template: >-
          {%- if is_state("binary_sensor.netatmo_habitacion_co2_down", "on") -%}
          mdi:arrow-down-thick
          {%- elif is_state("binary_sensor.netatmo_habitacion_co2_up", "on") -%}
          mdi:arrow-up-thick
          {%- else -%}
          mdi:window-minimize
          {%- endif %}

switch:
  - platform: template
    switches:
#      thermostat:
#        entity_id: sensor.entrance_hall_thermostat_temperature
#        value_template: "{{states('sensor.entrance_hall_thermostat_temperature')|float > 11.5}}"
#        turn_on:
#          service: script.turn_on
#          entity_id: script.climate_power_on
#        turn_off:
#          service: script.turn_on
#          entity_id: script.climate_power_off
      
      thermostat_away_mode:
        entity_id: climate.netatmo_general
        value_template: "{{is_state_attr('climate.netatmo_general', 'preset_mode', 'away')}}"
        turn_on:
          service: climate.set_preset_mode
          entity_id: climate.netatmo_general
          data:
            preset_mode: 'away'
        turn_off:
          service: climate.set_preset_mode
          entity_id: climate.netatmo_general
          data:
            preset_mode: 'Schedule'

input_boolean:
  home_comfort_mode:
    name: Modo extra calentito
    icon: 'mdi:fire'

weather:
  - platform: darksky
    api_key: !secret dark_sky_api_key
    latitude: !secret ha_latitude
    longitude: !secret ha_longitude
    units: 'ca'
    mode: daily